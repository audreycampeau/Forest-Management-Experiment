---
title: "Forest management experiment reveals divergent controls on the sources and age of lateral DOC and CO‚ÇÇ export in boreal streams"
author:
  - name: Audrey Campeau
    affiliation: Universit√© de Montr√©al & SLU
    orcid: 0000-0002-9113-8915
  - name: A. Zannella and M. Wallin
    #affiliation: Their Institution
    #orcid: 0000-0000-0000-0000
date: "`r Sys.Date()`"
format:
  html:
    theme: cosmo
    keep-tex: true
    code-fold: true
    code-summary: "üëà see code here"
    toc: true
    toc-depth: 2
    number-sections: true
    number-depth: 5
    fig-width: 8
    fig-height: 6
    fig-cap-location: margin
  
  pdf:
    documentclass: article
    toc: true
    toc-depth: 2
    number-sections: true
    fig-width: 6
    fig-height: 4
    fig-cap-location: bottom
    keep-tex: true
    echo: false        # Hide code in PDF only
    warning: false
    message: false
    
bibliography: references.bib
crossref:
  fig-title: "Figure"
  tbl-title: "Table"
  fig-prefix: "Figure"
  tbl-prefix: "Table"
---

# Introduction

## General Context

-   Lateral C export is a significant fraction of watershed C balance.

-   Forested catchments contain a large OM storage that could sustain DOC export for decades [@ledesma2013]

-   LCE and NEE are connected over long timescale, by hydrology [@√∂quist2014]

-   Isotopic values of C (stable and radiogenic) can inform us on the sources and age of C.

## Research Question

-   What are the controls over the sources and age of lateral CO2 and DOC export in forested catchments?

-   Can a forest manipulation experiment (forest clearcut and ditch cleaning) provide new insight to test ongoing hypothesis on the controls of LCE in forested catchments?

## Hypothesis

-   The CO2 source and age is more closely linked to the forest C sink [@campeau2019], so clearcutting the forest should have an impact on C sources and age

-   The DOC source and age is linked to discharge [@campeau2017] or water table position [@campeau2019], so changes in watershed hydrology, caused by clear-cutting and draining, should change the source and age of DOC.

## Main Conclusion

DOC is controled more by *hydrological processes*, which determines what material is being mobilised, while CO2 is controled more by *biological processes,* which fuels CO2 in the watershed. Both are therefore controled by different processes, but will likely respond to changes in climate, albeit via different drivers.

# Methodology

## Study Site and Treatment:

-   Six headwater catchments are included in this study:

    -   2 pristine sites (C1 and C2)

    -   4 treated watersheds (DC1 to DC4).

-   The DC sites received different treatments:

    -   Forest in all four sites was clearcut - around July 2020.

    -   Two sites, DC1 and DC3, were also ditch cleaned - in September 2021.

    -   The treatments are named as follow (pristine, clear-cut and ditch cleaning)

## Field measurements:

-   All four sites are monitored for flow and water chemistry on a near continuous basis.

-   Radiocarbon and stable C isotope measurements were collected at those six sites simultaniously and throughout various treatment stages.

-   14C measurements

    -   Start 2020-03-12

    -   End 2022-10-25

## Statistical analysis

-   Dunn's test for non-parametric grouping

-   Linear regression models, combined with ANCOVA to identify significant differences in intercept or slope.

-   Linear mixed-effect models would be possible if we wanted to build a predictive model, but this is not the aim here.

```{r, warning=FALSE, message=FALSE, echo=F}
# Import libraries
library(tidyverse) 
library(plotly) 
library(readxl) 
library(DT) # for interactive datatables
library(leaflet) #for interactive maps
library(htmltools)
library(rstatix) #anova test
library(ggpubr)# show reg.line equation 
library(ggcorrplot)


#Open dataset
DC_Q <- readRDS(file= "Output/Data/DC_C_Q_Meteo_chem_14C.rds")
DC_Q$Date <- as.Date(DC_Q$Date)
# Remove one oulier 14C-CO2 140%modern at C2 once. 
DC_Q$CO2_14C_Modern= ifelse(DC_Q$CO2_14C_Modern >130, NA, DC_Q$CO2_14C_Modern)


# Order factors site pairs 

  DC_Q$Site_id <- factor(DC_Q$Site_id, 
                       levels = c("C2", "C1", "DC1", "DC2", "DC3","DC4"))

#Code lines to exclude C2 and C1 (pristine control sites) from analysis 
DC_Q = filter(DC_Q, Site_id %in% c(#"C2", "C1", 
                                   "DC1", "DC2",  "DC3", "DC4"))

DC_Q_DC1and3 = filter(DC_Q, Site_id %in% c(#"C2", "C1", 
                                    "DC1", "DC3"))
DC_Q_DC2and4 = filter(DC_Q, Site_id %in% c(#"C2", "C1", 
                                    "DC2", "DC4"))

# Define Color Ramp and theme
treatments_colors <- c(
  "Pristine" = "deepskyblue",     # light blue
  "Clearcut" = "#CC6677",     # light red
  "Ditch cleaning" = "#882255" # dark red
)


site_colors_6 <- c(
  # Pristine sites (C2 and C1)
#  "C2" = "#228B22",  # Forest green
#  "C1" = "#90EE90",  # Light green
  
  # Clearcut pair - warm earth tones (your current DC1/DC2)
  "DC2" = "#E69B00", # Light orange
  "DC4" = "#994F00", #Dark brown
  
  # Clearcut+DitchCleaning pair - disturbed/muddy tones
  "DC1" = "#2E5894", #Dark blue
  "DC3" = "#7EA6E0" #Light blue
)

site_symbols <- c(
  "DC1" = 21,     
  "DC2" = 3,     
  "DC3" = 22,
  "DC4" =4
)

theme_set(theme_bw(base_size = 16))

#Present the dataset with interactivitiy
#datatable(filter(DC_Q, !is.na(DOC_14C_Modern)), options = list(pageLength = 5), filter="top") %>%  
#  formatStyle(columns = colnames(.$x$data), `font-size` = '10px')
```

# Results

## Figure 1: Timeseries C concentrations and ¬π‚Å¥C-content

```{r, warning=F, message=F,fig.height=10, fig.cap="C concentration and radiocarbon content timeseries coloured by sites"}


# Define operation periods for treatments::::::::::::::::::::::::::::::::::::::::::
  
clearcut_start <- as.Date("2020-07-01")
clearcut_end <- as.Date("2020-08-25")
ditch_cleaning_start <- as.Date("2021-09-01")
ditch_cleaning_end <- as.Date("2021-09-30")


# Timeseries 14C per site, CO2 and DOC seperately
plot_timeseries = function(data, y_var,labs_y) {
  ggplot(data, aes(x=Date, y=!!sym(y_var), group=Site_id, color=Site_id)) +
    geom_line(data=data[!is.na(data[[y_var]]), ]) +
    geom_point(size=3) +
  
  # Add gray background bars for operations
  annotate("rect", 
           xmin = clearcut_start, xmax = clearcut_end,
           ymin = -Inf, ymax = Inf,
           fill = "gray70", alpha = 0.3) +
  
  annotate("rect", 
           xmin = ditch_cleaning_start, xmax = ditch_cleaning_end,
           ymin = -Inf, ymax = Inf,
           fill = "gray70", alpha = 0.3) +
    
    scale_x_date(limits=c(as.Date("2020-01-01"), as.Date("2022-11-01")),
                 date_labels = "%b-%Y", date_breaks = "6 months") +
    scale_color_manual(values=c(site_colors_6))+
    labs(y=labs_y)+
    
    theme( # set margins to align combined plots 
      plot.margin = margin(5.5, 5.5, 5.5, 5.5, "pt"),
      axis.text.x = element_text(size = 10),
      axis.title.x = element_text(size = 11),
      panel.grid.major = element_line(size = 0.5),
      panel.grid.minor = element_line(size = 0.25)
    )

}



#Concentration timeseries


timeserie_DOC = ggExtra::ggMarginal(
  plot_timeseries(DC_Q, "DOC_mgL", "DOC (mg/L)")+
    # Add text labels for operations
 annotate("text", x = clearcut_start + (clearcut_end - clearcut_start)/2, y = Inf, 
           label = "Forest clear cut operations\n(July 2020)",
           vjust = 1.2, hjust = 0.5, size = 3.5, color = "black") +
  
  annotate("text", x = ditch_cleaning_start + (ditch_cleaning_end -    ditch_cleaning_start)/2, y = Inf, 
           label = "Ditch cleaning operations\n(September 2021)",
           vjust = 1.2, hjust = 0.5, size = 3.5, color = "black") +
   labs(y=bquote("DOC (mg C L"^-1*")"))+
   scale_y_log10()+
  theme(legend.position = "top", axis.title.x = element_blank()),
  margins=c("y"), type = "boxplot", groupColour = TRUE, groupFill = TRUE )


timeserie_14CDOC = ggExtra::ggMarginal(
  plot_timeseries(DC_Q, "DOC_14C_Modern", "14C-DOC (%)")+
  scale_y_continuous(limits=c(95,115))+
  labs(y = expression(""^14*"C-DOC (% modern)"))+
  theme(legend.position = "none", axis.title.x = element_blank()),
  margins=c("y"), type = "boxplot", groupColour = TRUE, groupFill = TRUE )



timeserie_CO2 = ggExtra::ggMarginal(
  plot_timeseries(DC_Q, "CO2_mgL", "CO2 (mg/L)")+
    labs(y=bquote("CO"[2]*" (mg C L"^-1*")"))+
     scale_y_log10()+
     theme(legend.position = "none", axis.title.x = element_blank()),
  margins=c("y"), type = "boxplot", groupColour = TRUE, groupFill = TRUE )

timeserie_14CCO2 = ggExtra::ggMarginal(
  plot_timeseries(DC_Q, "CO2_14C_Modern", "14C-CO2 (%)")+
  scale_y_continuous(limits=c(95,115))+
    labs(y = expression(""^14*"C-CO"[2]*" (% modern)"))+
   theme(legend.position = "none", axis.title.x = element_blank()),
  margins=c("y"), type = "boxplot", groupColour = TRUE, groupFill = TRUE )


# Combine four plots
ggarrange(  timeserie_DOC,
  timeserie_14CDOC,
  timeserie_CO2,
  timeserie_14CCO2,
  ncol = 1, align='v', heights = c( 0.65, 0.5, 0.5, 0.5),
  labels="AUTO")



```

#### Dunn's test \| ¬π‚Å¥C and \[C\] \~ Site

```{r}
# Calculate medians for each variable by Site_id
combined_medians <- DC_Q %>%
  group_by(Site_id) %>%
  summarise(
    "[DOC]" = round(median(DOC_mgL, na.rm = TRUE), 2),
    "14C-DOC" = round(median(DOC_14C_Modern, na.rm = TRUE),2),
    "[CO2]" = round(median(CO2_mgL, na.rm = TRUE), 2),
    "14C-CO2" = round(median(CO2_14C_Modern, na.rm = TRUE),2),
    .groups = 'drop'
  ) %>%
  rename(Site = Site_id)

knitr::kable(combined_medians, 
             caption = "Median by site for DOC and CO2 concentration and 14C-content")

```

```{r,warning =F, message=F}

library(dunn.test)
library(multcompView)
library(PMCMR)
# Perform the test and get multcomp letters
DOCSites_letters = multcompLetters(get.pvalues(PMCMRplus::kwAllPairsDunnTest(
          DC_Q$DOC_mgL ~ DC_Q$Site_id, p.adjust="bonf")),
          threshold=0.05)$Letters

DOC_14C_Sites_letters = multcompLetters(get.pvalues(PMCMRplus::kwAllPairsDunnTest(
          DC_Q$DOC_14C_Modern ~ DC_Q$Site_id, p.adjust="bonf")),
          threshold=0.05)$Letters
        
CO2Sites_letters = multcompLetters(get.pvalues(PMCMRplus::kwAllPairsDunnTest(
          DC_Q$CO2_mgL ~ DC_Q$Site_id, p.adjust="bonf")),
          threshold=0.05)$Letters

CO2_C14_Sites_letters = multcompLetters(get.pvalues(PMCMRplus::kwAllPairsDunnTest(
          DC_Q$CO2_14C_Modern ~ DC_Q$Site_id, p.adjust="bonf")),
          threshold=0.05)$Letters

        
# Combine into a data frame
combined_dunns_results <- data.frame(
  Site = names(DOCSites_letters),
  "[DOC]" = as.character(DOCSites_letters),
  "14C-DOC" = as.character(DOC_14C_Sites_letters),
  "[CO2]" = as.character(CO2Sites_letters[names(DOCSites_letters)]),
  "14C-CO2" = as.character(CO2_C14_Sites_letters[names(DOCSites_letters)]),
  check.names = FALSE
)

knitr::kable(combined_dunns_results, 
             caption = "Grouping letters for dunn's test result")
```

::: callout-note
#### Interpretation

**Trend:**

-   No obvious trends in C concentration or 14C content over time

-   There was a clear peak in DOC and CO2 concentration at DC4 during clearcut opperations.

**Differences between sites:**

-   CO2 and DOC concentration at DC4 is consistently higher than the other sites, followed with DC2, and DC1 and DC3.

-   14C-DOC is not different across sites

-   14C-CO2 is significantly lower at DC4, followed with DC3 and DC2, DC1 which is significantly higher
:::

::: callout-warning
#### Q data

The database contains DC3 and DC2 flow data, one ditch cleaned while the other only clearcut. Other timeseries are incomplete.
:::

## Figure 2: C \~ Q relationship

Is the radiocarbon age or concentration of DOC and CO~2~ controled by runoff, and does this relationship changes following treatment?

```{r, warning=F, message=F, fig.height=6, fig.width=12, fig.cap="relationship between C concetration and discharge coloured by site and treatment"}

# Hydrological control over  C concentration by Site

  ggplot(DC_Q %>% pivot_longer(
                     cols = c(DOC_mgL, CO2_mgL),
                     names_to = "Carbon_species",
                     values_to = "C_mgL"
                   ),
       aes(y=C_mgL, x=q_md_filled*1000,  fill=Treatment, color=Treatment))+ 
  geom_point(aes(shape=Site_id), size=1, alpha=0.7, show.legend = F)+
 
  geom_smooth(method="lm", se=F, aes(color=Treatment), show.legend = T)+
  stat_regline_equation(label.y.npc = "top", label.x.npc = "left",
  aes(label =  paste(..eq.label.., ..adj.rr.label.., 
                     sep = "~~~~"), color = Treatment), 
                      show.legend = F, size=3)+
  facet_grid(Carbon_species~Site_id, scale="free_y")+  
    
  scale_shape_manual(values=c(site_symbols))+
  scale_x_log10(limits = c(0.02, 30))+
  scale_y_log10()+
  scale_color_manual(values=treatments_colors)+
  scale_fill_manual(values=treatments_colors)+
  
  labs(x="q (mm/d)", y=bquote("C (mg/L)"))+
  theme(legend.position = "top", base_size=8)



```

#### ANCOVA test - DOC

Is there a significant difference in the hydrological response of **DOC** concentrations between *Treatments or Sites*?

```{r, warning=F}
#Run ANCOVA test - Difference in hydro. response between treatments

knitr::kable(DC_Q%>%  
             anova_test(DOC_mgL ~ q_md_filled*Treatment), 
             caption = "ANCOVA (ALL SITES) - DOC * q / treatment")

knitr::kable(filter(DC_Q, Site_id %in% c("DC1"))%>%  
             anova_test(DOC_mgL ~ q_md_filled*Treatment), 
             caption = "ANCOVA (DC1) - DOC * q / treatment")

knitr::kable(filter(DC_Q, Site_id %in% c("DC2"))%>%  
             anova_test(DOC_mgL ~ q_md_filled*Treatment), 
             caption = "ANCOVA (DC2) - DOC * q / treatment")

knitr::kable(filter(DC_Q, Site_id %in% c("DC3"))%>%   
             anova_test(DOC_mgL ~ q_md_filled*Treatment), 
             caption = "ANCOVA (DC3) - DOC * q / treatment")

knitr::kable(filter(DC_Q, Site_id %in% c("DC4"))%>%   
             anova_test(DOC_mgL ~ q_md_filled*Treatment), 
             caption = "ANCOVA (DC4) - DOC * q / treatment")
```

#### ANCOVA test - CO2

```{r, warning=F}
#Run ANCOVA test - Difference in hydro. response between treatments
knitr::kable(DC_Q  %>%  anova_test(CO2_mgL ~ q_md_filled*Treatment), 
             caption = "ANCOVA test results - CO2 * q / treatment")

knitr::kable(filter(DC_Q, Site_id %in% c("DC1"))%>%  
             anova_test(CO2_mgL ~ q_md_filled*Treatment), 
             caption = "ANCOVA (DC1) - CO2 * q / treatment")

knitr::kable(filter(DC_Q, Site_id %in% c("DC2"))%>%  
             anova_test(CO2_mgL ~ q_md_filled*Treatment), 
             caption = "ANCOVA (DC2) - CO2 * q / treatment")

knitr::kable(filter(DC_Q, Site_id %in% c("DC3"))%>%   
             anova_test(CO2_mgL ~ q_md_filled*Treatment), 
             caption = "ANCOVA (DC3) - CO2 * q / treatment")

knitr::kable(filter(DC_Q, Site_id %in% c("DC4"))%>%   
             anova_test(CO2_mgL ~ q_md_filled*Treatment), 
             caption = "ANCOVA (DC4) - CO2 * q / treatment")

```

::: callout-note
#### Interpretation

**Hydrological response:**

-   DOC and CO2 concentrations are not controled by discharge, except for DC4 where we believe there is a wetland source that could sustain flow in lowflow conditions.

-   ANCOVA indicates that Q **doesn't** have a significant effect on DOC concentration, but treatment and site do (intercept difference). Significant interaction between Q and Site (slope difference)

-   ANCOVA indicates that Q doesnt have a significant effect on CO2 concentration, nor does treatment. Site effect causes a signficant effect on intercept and slope (interaction)
:::

## Figure 3: Scatterplot C concentration or ¬π‚Å¥C-content by treatment

Is there a significant change in the median ^14^C content of CO~2~ and DOC between sites or treatment, based on their distribution ?

```{r, warning =F, message=F,fig.height=9, fig.width=5, fig.cap="relationship between C concentration and radiocarbon content of CO2 and DOC coloured by treatment"}

# Make a scatterplot to distinguish the grouping across sites
density_14Cscatter_sites = 
  ggExtra::ggMarginal(
  
            ggplot(data=DC_Q,
                 aes(x=DOC_mgL, y=CO2_mgL_filled, 
                    color=Treatment))+
            stat_density_2d(aes(fill = Treatment), geom = "polygon", linewidth=0,
                             alpha = 0.15)+ 
            geom_point(aes(shape=Site_id), size=1)+
            geom_smooth(method="glm", se=F, aes(color=Treatment), show.legend = T)+
  
            stat_regline_equation(label.y.npc = "top", label.x.npc = "left",
            aes(label =  paste(..eq.label.., ..adj.rr.label.., 
                               sep = "~~~~"), color = Treatment), 
                                show.legend = F, size=3)+
              scale_shape_manual(values=c(site_symbols))+
    
            scale_color_manual(values=c(treatments_colors))+
            scale_fill_manual(values=c(treatments_colors))+
            scale_y_log10()+
              scale_x_log10()+
            labs(x=bquote("DOC (mg L"^-1*")"), 
                   y=bquote("CO"[2]* " (mg L"^-1*")"))+
              theme(legend.position = "none"), 
            type = "boxplot", groupColour = TRUE, groupFill = TRUE ) 



# Make a scatterplot to distinguish the grouping across treatment
density_14Cscatter_treatment = 
ggExtra::ggMarginal(
  
            ggplot(data=DC_Q,aes(x=DOC_14C_Modern, y=CO2_14C_Modern, 
                    color=Treatment))+
              geom_abline(intercept=0,slope=1, linetype="dashed", color="gray30")+
            #   stat_density_2d(aes(fill = Treatment), geom = "polygon", linewidth=0,
             #                alpha = 0.2)+ 
              geom_segment(aes(xend = DOC_14C_Modern, yend = DOC_14C_Modern), 
                 alpha = 0.5, linetype = "solid", size = 0.5) +
            geom_point(aes(shape=Site_id),size=2)+
            scale_shape_manual(values=c(site_symbols))+
            scale_color_manual(values=c(treatments_colors))+
            scale_fill_manual(values=c(treatments_colors))+
            scale_y_continuous(limit=c(95,115))+
            scale_x_continuous(limit=c(95,115))+
            labs(x=bquote(Delta^14*"C-DOC (% modern)"), 
                   y=bquote(Delta^14*"C-CO"[2]*" (% modern)"))+
              theme(legend.position = "bottom"), 
            type = "boxplot", groupColour = TRUE, groupFill = TRUE )
            


ggarrange(density_14Cscatter_sites, 
density_14Cscatter_treatment, nrow=2, align="hv",labels="AUTO")

```

#### ANCOVA \| \[CO2\] \~ \[DOC\] / Treatment

```{r,warning=F }
#Run ANCOVA test - Difference in hydro. response between treatments


knitr::kable(DC_Q_DC1and3  %>%  anova_test(DOC_mgL ~ CO2_mgL_filled*Treatment), 
             caption = "Ancova test results: DOC ~ CO2 x Treatment")


```

#### Dunn's test \| ¬π‚Å¥C et \[C\]\~ Treatment

```{r,warning =F, message=F}
# Calculate medians for each variable by Site_id
range (DC_Q$q_md, na.rm=T)*1000
range (DC_Q$CO2_14C_Modern, na.rm=T)
range (DC_Q$DOC_14C_Modern, na.rm=T)
round(range(c(DC_Q$CO2_14C_Modern-DC_Q$DOC_14C_Modern), na.rm=T),0)

combined_medians <- DC_Q %>%
  group_by(Treatment) %>%
  summarise(
    "14C-DOC" = round(median(DOC_14C_Modern, na.rm = TRUE),2),
     "[DOC]" = round(median(DOC_mgL, na.rm = TRUE), 2),
    "14C-CO2" = round(median(CO2_14C_Modern, na.rm = TRUE),2),
    "[CO2]" = round(median(CO2_mgL, na.rm = TRUE), 2),
    .groups = 'drop'
  ) %>%
  rename(Site = Treatment)

knitr::kable(combined_medians, 
             caption = "Median by treatment for DOC and CO2 concentration and 14C-content")

```

```{r,warning =F, message=F}
library(dunn.test)
library(multcompView)
library(PMCMR)

# Perform the test and get multcomp letters
DOCTreatment_letters = multcompLetters(get.pvalues(PMCMRplus::kwAllPairsDunnTest(
          DC_Q$DOC_mgL ~ DC_Q$Treatment, p.adjust="bonf")),
          threshold=0.05)$Letters
        
DOC_C14_Treatment_letters = multcompLetters(get.pvalues(PMCMRplus::kwAllPairsDunnTest(
          DC_Q$DOC_14C_Modern ~ DC_Q$Treatment, p.adjust="bonf")),
          threshold=0.05)$Letters
        
CO2Treatment_letters = multcompLetters(get.pvalues(PMCMRplus::kwAllPairsDunnTest(
          DC_Q$CO2_mgL ~ DC_Q$Treatment, p.adjust="bonf")),
          threshold=0.05)$Letters

CO2_C14_Treatment_letters = multcompLetters(get.pvalues(PMCMRplus::kwAllPairsDunnTest(
          DC_Q$CO2_14C_Modern ~ DC_Q$Treatment, p.adjust="bonf")),
          threshold=0.05)$Letters

        
# Combine into a data frame
combined_dunns_results <- data.frame(
  Site = names(DOC_C14_Treatment_letters),
  "14C-DOC" = as.character(DOC_C14_Treatment_letters),
  "[DOC]" = as.character(DOCTreatment_letters),
  "14C-CO2" = as.character(CO2_C14_Treatment_letters[names(DOC_C14_Treatment_letters)]),
  "[CO2]" = as.character(CO2Treatment_letters[names(DOC_C14_Treatment_letters)]),
  check.names = FALSE
)


knitr::kable(combined_dunns_results, 
             caption = "Grouping letters for dunns test C concentration and 14C content by treatment")

```

#### Interpretation

**Relationship between CO2 and DOC concentration:**

-   The relationship between CO2 and DOC concentration is positive for pristine condition, but the slope becomes less significant with clearcut (closer to 0) and not significant (slope =0) with ditch cleaning. Hence the DOC concentration continues to vary across a wide range with treatments, but the CO2 becomes more stable and independant of DOC concentration. This could be due to changes in their mobilization pathways or simply because clearcuting "removes" a CO2 source.

**Treatment** **effect on C concentrations:**

-   The DOC concentrations are significantly higher following clearcut treatment compared with ditchcleaned and pristine conditions (short term effect of ditch cleaning can compensate?)

-   The CO2 concentration do not differ significantly across treatment

**Treatment** **effect on 14 content**

-   The ^14^C-DOC is significantly lower in the pristine (group a) compared with clearcut and ditch cleaning sites.

-   The ^14^C-CO~2~ doesn't differ significantly across treatments

## Figure 4: 14C \~ Q relationship

```{r, warning=FALSE, message=FALSE, fig.height=12, fig.width=5, fig.cap="relationship between radiocarbon content of CO2 and DOC and discharge, coloured by treatment"}
#Scatter coloured by Treatment
#14C-DOC -q scatter
plot_DOC_q = ggplot(DC_Q %>% filter(!is.na(DOC_14C_Modern)),
                   aes(y = DOC_14C_Modern, x = q_md_filled * 1000, 
                       fill = Treatment, color = Treatment)) +
  geom_point(aes(shape = Site_id), size = 3, show.legend = F) +
  geom_smooth(method = "lm", se = F, aes(color = Treatment), show.legend = F) +
  scale_shape_manual(values = site_symbols) +
  scale_fill_manual(values = treatments_colors) + 
  scale_color_manual(values = treatments_colors) + 
  scale_x_continuous(limits = c(0, 20)) +
  stat_regline_equation(
    label.y.npc = "top", label.x.npc = "left",
    aes(label = paste(..eq.label.., ..adj.rr.label.., sep = "~~~~"), 
        color = Treatment), 
    show.legend = F, size = 4) +
  labs(x = "", 
       y = bquote(Delta^14*"C-DOC (% modern)")) +
  theme(legend.position = "none")  # Hide legend for second plot to avoid duplication


#14C-CO2 -q scatter
plot_CO2_q = ggplot(DC_Q %>% filter(!is.na(CO2_14C_Modern)),
                   aes(y = CO2_14C_Modern, x = q_md_filled * 1000, 
                       fill = Treatment, color = Treatment)) +
  geom_point(aes(shape = Site_id), size = 3, show.legend = F) +
  geom_smooth(method = "lm", se = F, aes(color = Treatment), 
              show.legend = F, type="dashed") +
  scale_shape_manual(values = site_symbols) +
  scale_fill_manual(values = treatments_colors) + 
  scale_color_manual(values = treatments_colors) + 
  scale_x_continuous(limits = c(0, 20)) +
  stat_regline_equation(
    label.y.npc = "top", label.x.npc = "left",
    aes(label = paste(..eq.label.., ..adj.rr.label.., sep = "~~~~"), 
        color = Treatment), 
    show.legend = F, size = 4) +
  labs(x = "", 
       y = bquote(Delta^14*"C-CO"[2]*" (% modern)")) +
  theme(legend.position = "right")


# Add marginal boxplots
#plot_CO2_marginal = ggExtra::ggMarginal(plot_CO2_q, type = "boxplot", 
#                                groupColour = TRUE, groupFill = TRUE)
#plot_DOC_marginal = ggExtra::ggMarginal(plot_DOC_q, type = "boxplot", 
#                                groupColour = TRUE, groupFill = TRUE)


#Exceedance probability plot ::::::::::::::::::::::::::::::::::::::::::::::
#Database
Wide_q=DC_wide <- DC_Q %>%
  filter(Site_id %in% "DC3")%>%
  distinct(Date, Site_id, q_md, Treatment) %>%  # Remove any duplicate rows
  pivot_wider(
    id_cols = c(Date,Treatment),
    names_from = "Site_id",
    values_from = "q_md",
    names_prefix = "q_md_"
  )

# Calculations
Q_DC3_rank = Wide_q%>%
  group_by(Treatment)%>%
  mutate(rank = rank(-q_md_DC3)) %>%
  mutate(P = 100 * (rank / (length(q_md_DC3) + 1))) %>%
  ungroup()


# Identify dates when 14C-DOC samples were collected
DOC_14C_samples <- DC_Q %>%
  filter(Site_id == "DC3", !is.na(DOC_14C_Modern)) %>%
  select(Date, q_md, Treatment, DOC_14C_Modern) %>%
  distinct()

# Join with the ranked data
samples_with_exceedance <- DOC_14C_samples %>%
  left_join(Q_DC3_rank %>% select(Date, P), by = "Date")
#View(samples_with_exceedance)

#Visualisation
q_exceedance=ggplot(data = Q_DC3_rank) +
  geom_line(aes(y = P, x = q_md_DC3 * 1000, color = Treatment), size = 0.75) +
  # Add points for 14C-DOC sampling dates
  geom_point(data = samples_with_exceedance,
             aes(y = P, x = q_md * 1000, color = Treatment, fill=Treatment),
             size = 3, shape = 22) +
  #scale_x_log10() +
  scale_y_continuous(breaks = seq(0, 100, 25)) +
  scale_x_continuous(limits=c(0,20))+
  scale_color_manual(values = treatments_colors) +
  scale_fill_manual(values = treatments_colors) +
  labs(y = "(%) exceedance probability",
       x = "q specific (mm/d)") +
  theme(legend.position = "none")





# Combine using ggarrange :::::::::::::::::::::::::::::::::::::::::::::::::::::
ggarrange( plot_DOC_q, plot_CO2_q, q_exceedance,
                          ncol = 1, nrow = 3, align="v",
                          labels="AUTO")



```

#### ANCOVA test

Is there a significant difference in the hydrological response of **14C-DOC** between *Treatments*?

```{r, warning=F, echo=FALSE}
#Run ANCOVA test - Difference in hydro. response between treatments
knitr::kable(DC_Q  %>%  anova_test(DOC_14C_Modern ~ q_md_filled*Treatment), 
             caption = "Ancova test results: 14C-DOC ~ q x Treatment")
```

Is there a significant difference in the hydrological response of **14C-DOC** between *Sites*?

```{r, warning=F, echo=FALSE}
#Run ANCOVA test - Difference in hydro. response between Sites
knitr::kable(DC_Q %>% anova_test(DOC_14C_Modern ~ q_md_filled*Site_id),
             caption="ANCOVA test results, 14C-DOC * q / Site")


```

Is there a significant difference in the hydrological response of **14C-CO2** between *Treatments*?

```{r, warning=F, echo=FALSE}
#Run ANCOVA test - Difference in hydro. response between treatments
knitr::kable(DC_Q  %>%  anova_test(CO2_14C_Modern ~ q_md_filled*Treatment), 
             caption = "Ancova test results: 14C-CO2 ~ q x Treatment")
```

::: callout-note
#### Interpretation

-   While q doesn't have a significant effect on DOC concentration, it does have a signficant effect on 14C-DOC. The 14C-content generally increases with Q, mobilizing more post-bomb C stored in soils.

-   Treatment has a significant effect in the ANCOVA, indicating that the intercept shift in the 14C-DOC\~q relationship, from 100%modern in pristine sites to 110%modern in clearcut+ditchcleaned sites, is significant. The effect of Site is not significant.

-   Q doesnt have en effect but not on 14C-CO2
:::

## Figure 5: Keeling plots ^14^C-CO~2~ - CO2

```{r, warning=F, message=F, fig.height=8, fig.width=5, fig.cap="Keeling plot of CO2 isotope ratio, stable and radiogenic, coloured by treatment"}

DC_Q$CO2_mgL_filled_keeling= 1/DC_Q$CO2_mgL_filled
DC_Q$CO2_mgL_filled_keeling = ifelse(is.infinite (DC_Q$CO2_mgL_filled_keeling), NA, DC_Q$CO2_mgL_filled_keeling)



# Create Keeling plot for 14C-CO2
plot_14C <- ggplot(DC_Q %>% filter(!is.na(CO2_14C_Modern)), 
                   aes(y=CO2_14C_Modern, x=CO2_mgL_filled_keeling, color=Treatment)) +
  #stat_density_2d(aes(fill = Treatment), geom = "polygon", linewidth=0,
  #                           alpha = 0.1)+
  geom_smooth(method="lm", se=F, show.legend = F) + 
  geom_point(aes(shape=Site_id), size=3) +
  stat_regline_equation(
    label.y.npc = "top", label.x.npc = "left",
    aes(label = paste(..eq.label.., ..adj.rr.label.., sep = "~~~~")), 
    show.legend = F, size=4) +
  scale_color_manual(values = treatments_colors) +
  scale_fill_manual(values = treatments_colors) +
  scale_shape_manual(values = site_symbols) +
  scale_x_continuous(limits=c(0,1.15))+
  labs(x = "", y = expression(""^14*"C-CO"[2]*" (% modern)")) +
  theme(legend.position = "none")

# Create Keeling plot for d13C-CO2
plot_d13C <- ggplot(DC_Q %>% filter(!is.na(d13C_CO2)), 
                    aes(y=d13C_CO2, x=CO2_mgL_filled_keeling, color=Treatment)) +
  geom_smooth(method="lm", se=F, show.legend = F) + 
  geom_point(aes(shape=Site_id), size=3) +
  stat_regline_equation(
    label.y.npc = "top", label.x.npc = "left",
    aes(label = paste(..eq.label.., ..adj.rr.label.., sep = "~~~~")), 
    show.legend = F, size=4) +
  scale_x_continuous(limits=c(0,1.15))+
  scale_color_manual(values = treatments_colors) +
  scale_shape_manual(values = site_symbols) +
  labs(x = expression("1/CO"[2]), y = expression(delta^13*"C-CO"[2]*" (‚Ä∞)")) +
  theme(legend.position = "bottom")

# Add marginal plots
plot_14C_marginal <- ggExtra::ggMarginal(plot_14C, type = "boxplot", margins="y",
                                         groupColour = TRUE, groupFill = TRUE)
plot_d13C_marginal <- ggExtra::ggMarginal(plot_d13C, type = "boxplot", margins="y",
                                          groupColour = TRUE, groupFill = TRUE)

# Combine plots
ggarrange(plot_14C_marginal, plot_d13C_marginal, ncol = 1, labels="AUTO",
          heights = c(0.60,0.75))

```

#### ANCOVA test

Does the keeling relationship for **d13C-CO2** varies significantly between treatment?

```{r, warning = F, message = F}

#Run ANCOVA test - Difference in hydro. response between Sites
knitr::kable(DC_Q %>% anova_test(d13C_CO2 ~ CO2_mgL_filled_keeling*Treatment),
             caption="ANCOVA test results, 13C-CO2 Keeling | Treatment") 
#DC_Q %>% anova_test(d13C_CO2 ~ CO2_mgL_filled_keeling*Site_id)

```

Does the keeling relationship for **14C-CO2** varies significantly between treatment?

```{r, warning = F, message = F}
#Run ANCOVA test - Difference in hydro. response between Sites
knitr::kable(DC_Q %>% anova_test(CO2_14C_Modern ~ CO2_mgL_filled_keeling*Treatment),
             caption="ANCOVA test results, 14C-CO2 Keeling | Treatment") 
#DC_Q %>% anova_test(CO2_14C_Modern ~ CO2_mgL_filled_keeling*Site_id)
```

::: callout-note
#### Interpretation

-   The keeling plot suggests that CO2 concentration has a significant effect on both d13C-value and 14C-concent, which supports the hypothesis of a biological control with rapid turnover.

-   This relationship doesn't change signficantly with treatment. Perhaps the sample size is not enough to identify a meaningful effect?

-   The d13C source of CO2 is (-25‚Ä∞) (no signficant effect of slope or intercept across sites or treatment)

-   The 14C source of CO2 is between 99, 100m and 94. Which are large differences in 14C terms, but don't appear as significant effects in the model.
:::

# Supplementary Files

## Supplementary Figure S1: Hydrograph

```{r, warning=F, message=F, fig.height=7, label: fig-timeseries, fig.cap="Precipitation and discharge timeseries"}
 
# Make the precipitation graph :::::::::::::::::::::::::::::::::::::::::::::::::::::


precipitation= ggplot(DC_Q %>%
         filter(Site_id %in% c("DC1")),
       aes(y = P, x = as.Date(Date), color = Site_id)) +
  
  # Add gray background bars for operations
  annotate("rect", 
           xmin = clearcut_start, xmax = clearcut_end,
           ymin = -Inf, ymax = Inf, fill = "gray70", alpha = 0.3) +
  
  annotate("rect", 
           xmin = ditch_cleaning_start, xmax = ditch_cleaning_end,
           ymin = -Inf, ymax = Inf, fill = "gray70", alpha = 0.3) +
  
  geom_bar(stat = 'identity', width=0.2) +
  labs( y= "Precipitation (mm/day)") +
  scale_y_reverse()+
  scale_color_manual(values=site_colors_6)+ #"
  scale_x_date(limits=c(as.Date("2020-01-01"), as.Date("2022-11-01")),
               date_labels = "%b-%Y", date_breaks = "6 months") +
  
  
  labs(y = "precipitation (mm/d)",  x = "Date") +
  theme(legend.position = "none", axis.title.x = element_blank())



# Make Hydrograph :::::::::::::::::::::::::::::::::::::::::::::::::::::

hydrograph= ggplot(DC_Q %>%
         filter(Site_id %in% c("DC2", "DC3")),
       aes(y = q_md*1000, x = as.Date(Date), color = Site_id)) +
  
  # Add gray background bars for operations
  annotate("rect", 
           xmin = clearcut_start, xmax = clearcut_end,
           ymin = -Inf, ymax = Inf,
           fill = "gray70", alpha = 0.3) +
  
  annotate("rect", 
           xmin = ditch_cleaning_start, xmax = ditch_cleaning_end,
           ymin = -Inf, ymax = Inf,
           fill = "gray70", alpha = 0.3) +
  
  # Add the discharge lines
  geom_line() +
  scale_color_manual(values=site_colors_6)+ #"
   
  # Add text labels for operations
 annotate("text", x = clearcut_start + (clearcut_end - clearcut_start)/2, y = Inf, 
           label = "Forest clear cut operations\n(July 2020)",
           vjust = 1.2, hjust = 0.5, size = 3.5, color = "black") +
  
  annotate("text", x = ditch_cleaning_start + (ditch_cleaning_end -    ditch_cleaning_start)/2, y = Inf, 
           label = "Ditch cleaning operations\n(September 2021)",
           vjust = 1.2, hjust = 0.5, size = 3.5, color = "black") +
  
  scale_x_date(limits=c(as.Date("2020-01-01"), as.Date("2022-11-01")),
                 date_labels = "%b-%Y", date_breaks = "6 months") +
  labs(y = "specific discharge (mm/d)",   x = "Date",  color = "Stream") +
  theme(legend.position = "top", axis.title.x = element_blank())



ggarrange(precipitation, hydrograph,
          ncol=1, align="v", labels="AUTO")


```

## Supplementary Figure S2: density plot, P vs R

```{r,warning=F, message=F,fig.height=4, fig.cap="Density plot of precipitation and discharge"}


ggplot(DC_Q %>% filter(Site_id %in% c("DC2", "DC3")),
        aes(y = q_md*1000, x = P, color = Treatment, fill=Treatment))+
  stat_density_2d(aes(fill = Treatment), geom = "polygon", linewidth=0.5,
                             alpha = 0.2)+
        #geom_density2d(aes(fill = Treatment), alpha=0.2)+
scale_x_log10(limits=c(0.09,50))+
  scale_y_log10()+
  scale_fill_manual(values=treatments_colors)+
   scale_color_manual(values=treatments_colors)+
  facet_wrap(~Site_id)+
  labs(x="precipitation (mm/d)",y="specific discharge (mm/d)" )
         #   stat_density_2d(aes(fill = Treatment), geom = "polygon", linewidth=0,
                             #alpha = 0.2)+
         
```

## Supplementary Figure S3: correlation matrix

```{r, warning=F, message=F,fig.height=4, fig.cap="Correlation matrix Stream water chemistry timeseries"}

# Correlation matrix for DOC concentration across sites over time
DC_wide_DOC <- DC_Q %>%
  select(Date, Site_id, DOC_mgL) %>%
  filter(!is.na(DOC_mgL)) %>%  # Remove NA values first
  group_by(Date, Site_id) %>%
  summarise(DOC_mgL = mean(DOC_mgL, na.rm = TRUE), .groups = 'drop') %>%  # Take mean if duplicates
  pivot_wider(names_from = Site_id, 
              values_from = DOC_mgL,
              names_prefix = "")

cor_matrix_DOC <- cor(DC_wide_DOC[, -1], 
                      method = "spearman", 
                      use = "pairwise.complete.obs")


# Correlation matrix for CO2 concentration across sites over time
DC_wide_CO2 <- DC_Q %>%
  select(Date, Site_id, CO2_mgL) %>%
  filter(!is.na(CO2_mgL)) %>%  # Remove NA values first
  group_by(Date, Site_id) %>%
  summarise(CO2_mgL = mean(CO2_mgL, na.rm = TRUE), .groups = 'drop') %>%  # Take mean if duplicates
  pivot_wider(names_from = Site_id, 
              values_from = CO2_mgL,
              names_prefix = "")

cor_matrix_CO2 <- cor(DC_wide_CO2[, -1], 
                      method = "spearman", 
                      use = "pairwise.complete.obs")


# Correlation matrix for 14CCO2 concentration across sites over time
DC_wide_CO2_14C <- DC_Q %>%
  select(Date, Site_id, CO2_14C_Modern) %>%
  filter(!is.na(CO2_14C_Modern)) %>%  # Remove NA values first
  group_by(Date, Site_id) %>%
  summarise(CO2_14C = mean(CO2_14C_Modern, na.rm = TRUE), .groups = 'drop') %>%  # Take mean if duplicates
  pivot_wider(names_from = Site_id, 
              values_from = CO2_14C,
              names_prefix = "")


cor_matrix_CO2_14C <- cor(DC_wide_CO2_14C[, -1], 
                      method = "spearman", 
                      use = "pairwise.complete.obs")



# Correlation matrix for 14C-DOC concentration across sites over time
DC_wide_DOC_14C <- DC_Q %>%
  select(Date, Site_id, DOC_14C_Modern) %>%
  filter(!is.na(DOC_14C_Modern)) %>%  # Remove NA values first
  group_by(Date, Site_id) %>%
  summarise(DOC_14C = mean(DOC_14C_Modern, na.rm = TRUE), .groups = 'drop') %>%  # Take mean if duplicates
  pivot_wider(names_from = Site_id, 
              values_from = DOC_14C,
              names_prefix = "")


cor_matrix_DOC_14C <- cor(DC_wide_DOC_14C[, -1], 
                      method = "spearman", 
                      use = "pairwise.complete.obs")


#___________________________________________________________________________________

corplot_DOC=ggcorrplot(cor_matrix_DOC, method="square", type="upper", lab=T,insig = "blank",outline.col = "white", title = "[DOC]")
corplot_14DOC=ggcorrplot(cor_matrix_DOC_14C, method="square", type="upper", lab=T,insig = "blank",outline.col = "white", title = "14C-DOC")
corplot_CO2=ggcorrplot(cor_matrix_CO2, method="square", type="upper", lab=T,insig = "blank",outline.col = "white", title = "[CO2]")
corplot_14CO2=ggcorrplot(cor_matrix_CO2_14C, method="square", type="upper", lab=T,insig = "blank",outline.col = "white",title = "14C-CO2")


ggarrange(corplot_DOC,corplot_14DOC,
          corplot_CO2, corplot_14CO2,
          labels = "AUTO", nrow=2, ncol=2)


```

## Supplementary Figure S4: overall C-q relationship model

```{r, fig.width=5, fig.height=8,warning=F, message=F}
# Hydrological control over C concentration overall model
ggplot(DC_Q %>% pivot_longer(
                     cols = c(DOC_mgL, CO2_mgL),
                     names_to = "Carbon_species",
                     values_to = "C_mgL"
                   ),
       aes(y=C_mgL, x=q_md_filled*1000,  fill=Treatment, color=Treatment))+ 
  geom_point(aes(shape=Site_id), size=1, alpha=0.7, show.legend = F)+
 
  geom_smooth(method="lm", se=F, aes(color=Treatment), show.legend = T)+
  stat_regline_equation(label.y.npc = "top", label.x.npc = "left",
  aes(label =  paste(..eq.label.., ..adj.rr.label.., 
                     sep = "~~~~"), color = Treatment), 
                      show.legend = F, size=3)+
  facet_wrap(~Carbon_species, scale="free_y", nrow=2)+  
    
  scale_shape_manual(values=c(site_symbols))+
  scale_x_log10()+
  scale_y_log10()+
  scale_color_manual(values=treatments_colors)+
  scale_fill_manual(values=treatments_colors)+
  
  labs(x="q (mm/d)", y=bquote("C (mg/L)"))+
  theme(legend.position = "top", base_size=8)


```

# Summary tables

```{r,warning=F, message=F, echo=T}

library(lubridate)

# Extract rows with 14C data (either DOC or CO2)
C14_data <- DC_Q %>%
  filter(!is.na(DOC_14C_Modern) | !is.na(CO2_14C_Modern))

# Overall date range
date_summary <- C14_data %>%
  summarise(
    first_sampling = min(Date, na.rm = TRUE),
    last_sampling = max(Date, na.rm = TRUE),
    total_days = as.numeric(last_sampling - first_sampling),
    total_samples = n()
  )

cat("Overall 14C sampling period:\n")
print(date_summary)

# Sample counts by site and type
sample_counts <- C14_data %>%
  group_by(Site_id) %>%
  summarise(
    n_total = n(),
    n_DOC_14C = sum(!is.na(DOC_14C_Modern)),
    n_CO2_14C = sum(!is.na(CO2_14C_Modern)),
    n_both = sum(!is.na(DOC_14C_Modern) & !is.na(CO2_14C_Modern)),
    first_date = min(Date),
    last_date = max(Date)
  )

cat("\n14C samples by site:\n")
print(sample_counts)

# Calculate intervals between measurements for each site
intervals_by_site <- C14_data %>%
  arrange(Site_id, Date) %>%
  group_by(Site_id) %>%
  mutate(
    days_since_last = as.numeric(Date - lag(Date))
  ) %>%
  summarise(
    mean_interval_days = mean(days_since_last, na.rm = TRUE),
    median_interval_days = median(days_since_last, na.rm = TRUE),
    min_interval_days = min(days_since_last, na.rm = TRUE),
    max_interval_days = max(days_since_last, na.rm = TRUE)
  )

cat("\nSampling intervals by site (days):\n")
print(intervals_by_site)

# More detailed view: all sampling dates and intervals
detailed_intervals <- C14_data %>%
  select(Date, Site_id, DOC_14C_Modern, CO2_14C_Modern) %>%
  arrange(Date) %>%
  mutate(
    days_since_previous = as.numeric(Date - lag(Date)),
    sample_type = case_when(
      !is.na(DOC_14C_Modern) & !is.na(CO2_14C_Modern) ~ "Both",
      !is.na(DOC_14C_Modern) ~ "DOC only",
      !is.na(CO2_14C_Modern) ~ "CO2 only"
    )
  )

cat("\nFirst 10 sampling events with intervals:\n")
print(head(detailed_intervals, 10))

# Summary statistics
cat("\n=== SUMMARY ===\n")
cat(sprintf("Total 14C samples collected: %d\n", nrow(C14_data)))
cat(sprintf("Sampling period: %s to %s (%d days)\n", 
            date_summary$first_sampling, 
            date_summary$last_sampling,
            date_summary$total_days))
cat(sprintf("Average sampling interval: %.1f days\n", 
            mean(detailed_intervals$days_since_previous, na.rm = TRUE)))
cat(sprintf("Number of sites sampled: %d\n", n_distinct(C14_data$Site_id)))



# Total counts by site and sample type
total_by_type <- C14_data %>%
  group_by(Site_id) %>%
  summarise(
    `14C-DOC samples` = sum(!is.na(DOC_14C_Modern)),
    `14C-CO2 samples` = sum(!is.na(CO2_14C_Modern))
  ) %>%
  arrange(Site_id)

cat("\nTotal 14C samples by type at each site:\n")
print(total_by_type)
```
